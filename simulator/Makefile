# --- åŸºç¡€è·¯å¾„å®šä¹‰ ---
SIM_HOME := $(abspath .)
BUILD_DIR := $(SIM_HOME)/build
OBJ_DIR := $(BUILD_DIR)/obj_dir
INC_DIR := $(SIM_HOME)/include
SRC_DIR := $(SIM_HOME)/src

# --- 1. å¼•å…¥ Kconfig é…ç½®é€»è¾‘ ---
# å¿…é¡»å…ˆå¼•å…¥ Makefile.conf ä»¥è·å¾— CONFIG_xxx å˜é‡
include Makefile.conf

# --- æ ¸å¿ƒå˜é‡å®šä¹‰ ---
TOPNAME := top_cpu
CPU_DIR := $(SIM_HOME)/IP/rv64-pipeline-cpu-2026-ready-valid
BIN := $(BUILD_DIR)/$(TOPNAME)

# --- ç¼–è¯‘å™¨è®¾ç½® ---
VERILATOR = verilator
VERILATOR_CFLAGS += -MMD --build -j 8 -trace-fst -cc -O0 
VERILATOR_CFLAGS += --x-assign fast --x-initial fast --noassert
VERILATOR_CFLAGS += -I$(CPU_DIR) --top-module $(TOPNAME) --prefix npc

# --- ç¼–è¯‘å‚æ•°æ˜ å°„ ---
INC_PATH = $(INC_DIR) $(INC_DIR)/utils $(INC_DIR)/riscv $(INC_DIR)/difftest
INCFLAGS := $(addprefix -I, $(INC_PATH))

# é“¾æ¥åº“ä¸ CXX æ ‡å¿—
LDFLAGS += -lreadline -lhistory -ldl -pie $(shell llvm-config --libs)
CXXFLAGS += $(INCFLAGS) -DTOP_NAME=npc -fpermissive

# --- æºç æ‰«æ ---
VSRCS = $(shell find $(abspath $(CPU_DIR)) -name "*.v" -o -name "*.sv")
CSRCS = $(shell find $(abspath $(SRC_DIR)) -name "*.c" -o -name "*.cpp" -o -name "*.cc")

# --- é¢œè‰²ä¸å›¾æ ‡å®šä¹‰ ---
BLUE   = \033[1;34m
GREEN  = \033[1;32m
PURPLE = \033[1;35m
CYAN   = \033[1;36m
YELLOW = \033[1;33m
RESET  = \033[0m
ROCKET = ğŸš€
CHECK  = âœ…
BUILD  = ğŸ› ï¸
RUN    = ğŸƒ

# --- æ„å»ºè§„åˆ™ ---

default: $(BIN)

# æ ¸å¿ƒï¼šäºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–äº $(AUTOCONF_H)ï¼Œç¡®ä¿é…ç½®æ›´æ”¹åè‡ªåŠ¨è§¦å‘é‡æ–°ç¼–è¯‘
$(BIN): $(VSRCS) $(CSRCS) $(AUTOCONF_H)
	@echo "$(BLUE)$(BUILD) [1/2] Preparing build directory...$(RESET)"
	@mkdir -p $(BUILD_DIR)
	@rm -rf $(OBJ_DIR)
	@echo "$(PURPLE)$(ROCKET) [2/2] Starting Verilator compilation...$(RESET)"
	$(VERILATOR) $(VERILATOR_CFLAGS) $(VSRCS) $(CSRCS) \
		$(addprefix -CFLAGS , $(CXXFLAGS)) \
		$(addprefix -LDFLAGS , $(LDFLAGS)) \
		--Mdir $(OBJ_DIR) --exe -o $(abspath $(BIN))
	@echo "$(GREEN)$(CHECK) Build successful! Binary: $(BIN)$(RESET)"

# --- è¿è¡Œé€»è¾‘ ---

# ç¤ºä¾‹ï¼šæ ¹æ® Kconfig ä¸­çš„é…ç½®åŠ¨æ€å¢åŠ è¿è¡Œå‚æ•°
override ARGS ?= --log=$(SIM_HOME)/bin/npc-log.txt
override ARGS += --diff=$(SIM_HOME)/diff/riscv64-spike-so

ifeq ($(CONFIG_BATCH_MODE),y)
    override ARGS += --batch
endif

run: $(BIN)
	@echo "$(CYAN)$(RUN) Launching simulation...$(RESET)"
	@$(BIN) $(ARGS) $(IMAGE)

sim:
	@echo "$(BLUE)ğŸŒŠ Opening GTKWave...$(RESET)"
	@gtkwave $(SIM_HOME)/waveform.fst

clean:
	@echo "$(YELLOW)ğŸ§¹ Cleaning up build artifacts...$(RESET)"
	@rm -rf $(BUILD_DIR)
	@rm -f $(AUTOCONF_H)
	@echo "$(GREEN)$(CHECK) Clean done.$(RESET)"

.PHONY: default all clean run sim menuconfig syncconfig